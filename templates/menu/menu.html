{% extends "main/home.html" %}
{% load static %}

{% block title %} <title>Restaurant Menu</title> {% endblock title %}

{% block style %}
    <link rel="stylesheet" href="{% static 'menu/menu.css' %}">
{% endblock style %}

{% block content %}
    <div class="container">
        <div id="toast" class="toast"></div>
        <section class="hero-section">
            <div class="award-badge">
                <span class="star">‚òÖ</span> Award-Winning Cuisine
            </div>
            
            <h1 class="hero-title">
                Experience the Art of <span class="highlight">Fine Dining</span>
            </h1>
            
            <p class="hero-subtitle">
                Discover our carefully crafted menu featuring the freshest ingredients and culinary expertise. 
                Order online for pickup or delivery.
            </p>
            
            <div class="info-badges">
                <div class="badge">
                    <span class="icon">üë®‚Äçüç≥</span> Master Chefs
                </div>
                <div class="badge">
                    <span class="icon">üïí</span> 30 Min Delivery
                </div>
                <div class="badge">
                    <span class="icon">‚≠ê</span> 4.9 Rating
                </div>
            </div>
        </section>

        <div class="category-filter">
            <select id="categorySelect">
                <option value="" selected disabled>Select Category</option>
                {% for data in menu_data %}
                    <option value="{{ data.category.name }}">
                        {{ data.category.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <h1 class="menu-title">üçΩÔ∏è Our Menu</h1>

        <div id="menuCategories">
            {% for data in menu_data %}
                <div class="category-section" data-category="{{ data.category.name }}">

                    <h2 class="category-name">{{ data.category.name }}</h2>
                    
                    <div class="menu-grid">
                        {% for item in data.items %}
                            <div class="food-card">
                                <div class="card-image">
                                    <img src="{{ item.img_url }}" alt="{{ item.name }}">
                                </div>
                                
                                <div class="card-content">
                                    <div class="card-header">
                                        <h3 class="item-name">{{ item.name }}</h3>
                                        <span class="price">‚Çπ{{ item.price }}</span>
                                    </div>
                                    <p class="description">{{ item.description }}</p>
                                    <button onclick="addToCart({{ item.id }})" class="btn">
                                        ‚ûï Add to Cart
                                    </button>
                                </div>
                            </div>
                        {% empty %}
                            <p>No items available</p>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="cartSidebar" class="cart-sidebar">
            
            <!-- HEADER -->
            <div class="cart-header" id="cart-header-inner">
                <div class="cart-title">
                    <span class="cart-icon-orange">üõçÔ∏è</span>
                    <h2>Your Cart</h2>
                    <span class="item-count-badge">0 items</span>
                </div>
                <button id="closeCart" class="close-btn">&times;</button>
            </div>

            
            {% if request.session.cart %}
                <!-- SCROLL AREA -->
                <div class="cart-scroll">
                    <div id="side-cart"></div>
                </div>
                <!-- FOOTER -->
                <div class="cart-footer">
                    <div class="total-row">
                        <span>Total</span>
                        <strong id="cart-total">‚Çπ0</strong>
                    </div>
                    <button class="checkout-btn" onclick="goToCheckout()">Proceed to Checkout</button>
                </div>
            {% else %}
                <div class="no-cart-container">
                    <div>
                        <p>Your cart is empty <br>
                            Add some delicious items to get started!</p>
                            <button>Browse Menu</button>
                    </div>
                </div>
            {% endif %}
            
        </div>
        <div id="cartOverlay" class="cart-overlay" onclick="toggleCart()"></div>
    </div>
        
{% endblock content %}
{% block script %}
<script>

    const cartSidebar = document.getElementById("cartSidebar");
    const cartOverlay = document.getElementById("cartOverlay");
    const closeCart = document.getElementById("closeCart");
    const cartBtn = document.getElementById("cartBtn"); // header cart icon
    const msg = document.querySelector(".message-add-to-cart");
    const add_to_cart_btn = document.querySelector(".btn");
    
    function goToCheckout() {
        window.location.href = "/checkout/";
    }

    
    function toggleCart() {
        cartSidebar.classList.toggle("open");
        cartOverlay.classList.toggle("show");

        document.body.classList.toggle("cart-open");

        if (cartSidebar.classList.contains("open")) {
            document.body.style.overflow = "hidden";
        } else {
            document.body.style.overflow = "auto";
        }
    }

    
    cartBtn.addEventListener("click", toggleCart);
    closeCart.addEventListener("click", toggleCart);
    
    
    document.getElementById("categorySelect").addEventListener("change", function () {
        const selectedCategory = this.value;
        if (!selectedCategory) return;
        
        const categoryContainer = document.getElementById("menuCategories");
        const categorySections = categoryContainer.querySelectorAll(".category-section");
        
        categorySections.forEach(section => {
            if (section.dataset.category === selectedCategory) {
                categoryContainer.prepend(section);
                
                // optional: smooth scroll to menu title
                document.querySelector(".menu-title").scrollIntoView({
                    behavior: "smooth",
                    block: "start"
                });
            }
        });
    });
    
    
    
    function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        
        toast.innerText = message;
        toast.className = `toast show ${type}`;
        
        setTimeout(() => {
            toast.className = "toast";
        }, 2000);
    }
    
    function addToCart(id) {
        fetch(`/add-to-cart/${id}/`)
        .then(res => res.json())
        .then(data => {
            updateSideCart(data);          // UI updated
            showToast("Item added to cart üõí");
        });
    }
    
    function increaseQty(id) {
        fetch(`/cart/increase/${id}/`)
        .then(res => res.json())
        .then(data => {
            updateSideCart(data);
            showToast("Quantity increased");
        });
    }
    
    function decreaseQty(id) {
        fetch(`/cart/decrease/${id}/`)
        .then(res => res.json())
        .then(data => {
            updateSideCart(data);
            showToast("Quantity decrease");
        });
    }
    
    function removeItem(id) {
        fetch(`/cart/remove/${id}/`)
        .then(res => res.json())
        .then(data => {
            updateSideCart(data);
            showToast("Item removed from cart", "remove");
        });
    }
    
    function updateSideCart(data) {
        const cartDiv = document.getElementById("side-cart");
        const totalSpan = document.getElementById("cart-total");
        const badge = document.querySelector(".item-count-badge");
        
        cartDiv.innerHTML = "";
        let count = 0;
        
        for (let id in data.cart) {
            const item = data.cart[id];
            count += item.quantity;
            
            cartDiv.innerHTML += `
            <div class="cart-item-card">
                <img src="${item.image}" class="cart-img">
                <div class="cart-middle">
                    <h4>${item.name}</h4>
                    <div class="qty-box">
                        <button onclick="decreaseQty(${id})">‚àí</button>
                        <span>${item.quantity}</span>
                        <button onclick="increaseQty(${id})">+</button>
                    </div>
                </div>
                <div class="cart-right">
                    <button class="trash" onclick="removeItem(${id})">üóë</button>
                    <div class="price">‚Çπ${(item.price * item.quantity).toFixed(2)}</div>
                </div>
            </div>
            `;
        }
        
        totalSpan.innerText = "‚Çπ" + data.total_price.toFixed(2);
        badge.innerText = `${count} items`;
    }
    
    document.addEventListener("DOMContentLoaded", () => {
        fetch('/get-cart/')
        .then(res => res.json())
        .then(updateSideCart);
    });
</script>
{% endblock script %}